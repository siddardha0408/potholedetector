<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RoadPulse AI | Infrastructure Auditor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f4f7f6; color: #333; font-family: 'Segoe UI', sans-serif; }
        .dashboard-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #dee2e6; }
        #map { height: 380px; border-radius: 12px; border: 1px solid #ced4da; }
        .graph-container { height: 420px; background: white; border-radius: 12px; padding: 10px; position: relative; border: 1px solid #ced4da; }
        .status-badge { font-size: 1.2rem; padding: 12px; border-radius: 8px; font-weight: bold; text-align: center; }
        .normal { background: #e7f3ef; color: #2d6a4f; border: 1px solid #b7e4c7; }
        .pothole-locked { background: #fdecea; color: #c0392b; border: 2px solid #e74c3c; animation: shadow-pulse 1.5s infinite; }
        @keyframes shadow-pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .tele-val { font-family: 'Consolas', monospace; color: #0077b6; font-size: 1.1rem; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container-fluid p-3">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="dashboard-card h-100">
                    <button id="sensorBtn" class="btn btn-outline-dark w-100 mb-2" onclick="initSensors()">1. INITIALIZE SENSORS</button>
                    <button class="btn btn-primary w-100 mb-3 fw-bold" onclick="startTracking()">2. LAUNCH AUDIT STREAM</button>
                    <div id="roadStatus" class="status-badge normal mb-3">SYSTEM STANDBY</div>
                    <div class="bg-light p-3 rounded border">
                        <h6 class="text-muted small fw-bold mb-2">LIVE TELEMETRY</h6>
                        <div class="d-flex justify-content-between mb-1"><span>Roughness (SD):</span> <span id="m_std" class="tele-val">0.00</span></div>
                        <div class="d-flex justify-content-between mb-1"><span>Peak-Peak (PTP):</span> <span id="m_ptp" class="tele-val">0.00</span></div>
                        <div class="d-flex justify-content-between"><span>Impact (Max G):</span> <span id="m_max" class="tele-val text-danger">0.00</span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-8 position-relative">
                <div class="position-absolute top-0 start-50 translate-middle-x mt-3" style="z-index:1000; width: 320px;">
                    <div class="input-group shadow-sm">
                        <input type="text" id="addressSearch" class="form-control" placeholder="Search neighborhood...">
                        <button class="btn btn-dark" onclick="searchAddress()">Search</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>
            <div class="col-12">
                <div class="dashboard-card">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 id="graphLabel" class="text-primary fw-bold m-0">VIBRATION ANALYSIS FEED</h5>
                        <button id="exitBtn" class="btn btn-outline-danger btn-sm px-3" style="display:none;" onclick="exitReplay()">RETURN TO LIVE</button>
                    </div>
                    <div class="graph-container"><canvas id="bigChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let vibrations = [], map, carMarker, bigChart, fleetMarkers = {};
        let manualLat = null, manualLon = null, isReplaying = false, hasPothole = false;

        map = L.map('map').setView([17.385, 78.486], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        carMarker = L.circleMarker([17.385, 78.486], {radius: 12, color: '#0077b6', fillColor: '#00b4d8', fillOpacity: 0.8, weight: 2, zIndexOffset: 1000}).addTo(map);

        const ctx = document.getElementById('bigChart').getContext('2d');
        bigChart = new Chart(ctx, {
            type: 'line',
            data: { labels: Array.from({length: 50}, (_, i) => i), datasets: [{ data: [], borderColor: '#0077b6', borderWidth: 3, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(0, 119, 182, 0.05)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 25 }, x: { display: false } }, plugins: { legend: { display: false } } }
        });

        async function searchAddress() {
            const q = document.getElementById('addressSearch').value;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data.length > 0) {
                manualLat = parseFloat(data[0].lat); manualLon = parseFloat(data[0].lon);
                map.flyTo([manualLat, manualLon], 16);
                carMarker.setLatLng([manualLat, manualLon]);
            }
        }

        async function initSensors() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') window.addEventListener('devicemotion', handleMotion);
            } else { window.addEventListener('devicemotion', handleMotion); }
            document.getElementById('sensorBtn').innerText = "SENSORS ONLINE";
            document.getElementById('sensorBtn').className = "btn btn-success w-100 mb-2";
        }

        function handleMotion(e) {
            let m = Math.sqrt(e.acceleration.x**2 + e.acceleration.y**2 + e.acceleration.z**2);
            vibrations.push(m); if(vibrations.length > 50) vibrations.shift();
        }

        function exitReplay() { 
            isReplaying = false; 
            document.getElementById('exitBtn').style.display='none'; 
            document.getElementById('graphLabel').innerText = "VIBRATION ANALYSIS FEED";
            bigChart.data.datasets[0].borderColor = '#0077b6';
        }

        function startTracking() {
            setInterval(() => {
                fetch('/audit', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ vibrations: vibrations, manualLat: manualLat, manualLon: manualLon }) 
                })
                .then(r => r.json()).then(d => {
                    if(!isReplaying) {
                        bigChart.data.datasets[0].data = d.vibrations;
                        bigChart.update('none');
                    }
                    document.getElementById('m_std').innerText = d.metrics.std;
                    document.getElementById('m_ptp').innerText = d.metrics.ptp;
                    document.getElementById('m_max').innerText = d.metrics.max;

                    if(d.status === 2) hasPothole = true;

                    if(hasPothole) {
                        document.getElementById('roadStatus').innerText = "ðŸš¨ POTHOLE IDENTIFIED";
                        document.getElementById('roadStatus').className = "status-badge pothole-locked";
                        carMarker.setStyle({color: '#c0392b', fillColor: '#e74c3c'});
                    }

                    carMarker.setLatLng([manualLat || d.lat, manualLon || d.lon]);

                    d.global_markers.forEach(p => {
                        let key = `m_${p.lat}_${p.lon}`.replace(/\./g, '_');
                        if(!fleetMarkers[key]) {
                            let m = L.circleMarker([p.lat, p.lon], {radius: 10, color: '#c0392b', fillColor: '#e74c3c', fillOpacity: 0.7, weight: 2}).addTo(map);
                            m.on('click', (e) => {
                                L.DomEvent.stopPropagation(e);
                                isReplaying = true;
                                document.getElementById('exitBtn').style.display = 'block';
                                document.getElementById('graphLabel').innerText = `REPLAY | SD: ${p.std} | PTP: ${p.ptp}`;
                                bigChart.data.datasets[0].data = p.snippet;
                                bigChart.data.datasets[0].borderColor = '#e74c3c';
                                bigChart.update();
                            });
                            fleetMarkers[key] = m;
                        }
                    });
                });
            }, 1000);
        }
    </script>
</body>
</html>

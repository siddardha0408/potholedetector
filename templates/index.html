<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RoadPulse AI | Technical Auditor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
        .dashboard-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        #map { height: 600px; border-radius: 12px; }
        .metric-box { font-family: monospace; font-size: 1.1rem; font-weight: bold; color: #0d6efd; }
        .status-badge { padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; }
        .normal { background: #d1e7dd; color: #0f5132; }
        .pothole { background: #f8d7da; color: #842029; border: 2px solid #f5c2c7; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div class="container-fluid p-3">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="dashboard-card">
                    <button id="sensorBtn" class="btn btn-dark w-100 mb-2" onclick="initSensors()">ACTIVATE SENSORS</button>
                    <button class="btn btn-primary w-100" onclick="startTracking()">START LIVE AUDIT</button>
                </div>

                <div class="dashboard-card bg-dark text-white">
                    <h6 class="small fw-bold text-secondary">LIVE SENSOR METRICS</h6>
                    <div class="d-flex justify-content-between"><span>SD (Roughness):</span> <span id="m_std" class="text-info">0.000</span></div>
                    <div class="d-flex justify-content-between"><span>Peak-to-Peak:</span> <span id="m_ptp" class="text-info">0.000</span></div>
                    <div class="d-flex justify-content-between"><span>Max G-Force:</span> <span id="m_max" class="text-warning">0.000</span></div>
                </div>

                <div id="replayCard" class="dashboard-card" style="display:none; border: 2px solid #dc3545;">
                    <h6 class="text-danger fw-bold small">EVIDENCE REPLAY</h6>
                    <div style="height: 120px;"><canvas id="replayChart"></canvas></div>
                    <div id="replayDetails" class="small mt-2 p-2 bg-light rounded"></div>
                    <button class="btn btn-sm btn-secondary w-100 mt-2" onclick="document.getElementById('replayCard').style.display='none'">Close</button>
                </div>

                <div class="dashboard-card">
                    <div id="roadStatus" class="status-badge normal">WAITING...</div>
                </div>
                
                <div class="dashboard-card" style="height: 150px;"><canvas id="liveChart"></canvas></div>
            </div>
            <div class="col-md-9 position-relative">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        let vibrations = [], map, carMarker, liveChart, replayChart, fleetMarkers = {};

        map = L.map('map').setView([17.385, 78.486], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        carMarker = L.circleMarker([0,0], {radius: 10, color: '#007bff', fillOpacity: 1}).addTo(map);

        const setupChart = (id, color) => new Chart(document.getElementById(id).getContext('2d'), {
            type: 'line', data: { labels: Array.from({length: 50}, (_, i) => i), datasets: [{ data: [], borderColor: color, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: color+'22' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { suggestedMax: 15 } } }
        });
        liveChart = setupChart('liveChart', '#0d6efd');
        replayChart = setupChart('replayChart', '#dc3545');

        async function initSensors() {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                const res = await DeviceMotionEvent.requestPermission();
                if (res === 'granted') window.addEventListener('devicemotion', handleMotion);
            } else { window.addEventListener('devicemotion', handleMotion); }
            document.getElementById('sensorBtn').innerText = "Sensors Connected";
        }

        function handleMotion(e) {
            let a = e.acceleration;
            let m = Math.sqrt((a.x||0)**2 + (a.y||0)**2 + (a.z||0)**2);
            vibrations.push(m); if(vibrations.length > 50) vibrations.shift();
        }

        function startTracking() {
            setInterval(() => {
                fetch('/audit', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ vibrations: vibrations }) })
                .then(r => r.json()).then(d => {
                    // Update Live Metrics
                    document.getElementById('m_std').innerText = d.metrics.std;
                    document.getElementById('m_ptp').innerText = d.metrics.ptp;
                    document.getElementById('m_max').innerText = d.metrics.max;
                    
                    document.getElementById('roadStatus').innerText = d.status === 2 ? "ðŸš¨ POTHOLE DETECTED" : "ROAD: CLEAR";
                    document.getElementById('roadStatus').className = "status-badge " + (d.status === 2 ? "pothole" : "normal");

                    liveChart.data.datasets[0].data = d.vibrations; liveChart.update();
                    carMarker.setLatLng([d.lat, d.lon]); map.setView([d.lat, d.lon]);

                    d.global_markers.forEach(p => {
                        let key = `${p.lat}_${p.lon}`;
                        if(!fleetMarkers[key]) {
                            fleetMarkers[key] = L.circleMarker([p.lat, p.lon], {radius: 12, color: 'red', fillOpacity: 0.7}).addTo(map)
                                .on('click', () => {
                                    document.getElementById('replayCard').style.display = 'block';
                                    replayChart.data.datasets[0].data = p.snippet; replayChart.update();
                                    document.getElementById('replayDetails').innerHTML = `
                                        <b>Metrics at Impact:</b><br>
                                        SD: ${p.std} | PTP: ${p.ptp} | Max: ${p.max}
                                    `;
                                }).bindPopup(`<b>Pothole Logged</b><br>Click to Replay Data`);
                        }
                    });
                });
            }, 1000);
        }
    </script>
</body>
</html>